var QCluster=function(a){var b;return b=function(a,b,c,d,e,f){var g,h,i,j,k,l;for(g=f,h=!1,i=b+c,j=a.length;!h;)i>=j||0>i?h=!0:(a[i].c||(k=Math.abs(a[i].x-a[b].x)/e,l=Math.abs(a[i].y-a[b].y)/e,g>k?g>l&&(d.points.push(a[i]),d.c=!0,a[i].c=!0):h=!0),i+=c)},a.clusterPoints=function(a,c,d,e){function f(a,b,c,d,e,f){return a>d||c>a||b>f||e>b?!1:!0}for(var g,h,i,k,l=0,m=[],n=a,o=n.length,i=o-1;i>=0;i--)n[i].c=null;for(var h=o-1;h>=0;h--)!n[h].c&&f(n[h].x,n[h].y,c.xmin,c.xmax,c.ymin,c.ymax)&&(k={id:l,points:[],xSum:0,ySum:0,cX:null,cY:null},l++,k.points.push(n[h]),b(n,h,-1,k,d,e),b(n,h,1,k,d,e),m.push(k));for(i=0,iMax=m.length;iMax>i;i++){for(g=m[i],j=0,jMax=g.points.length;jMax>j;j++)g.xSum=g.xSum+g.points[j].x,g.ySum=g.ySum+g.points[j].y;g.cX=g.xSum/g.points.length,g.cY=g.ySum/g.points.length,delete g.xSum,delete g.ySum}return m},a.moreThanOneCluster=function(a,c,d){for(var e,f,g,h=0,i=[],j=a,k=j.length,f=k-1;f>=0;f--)j[f].c=null;for(var e=k-1;e>=0;e--)j[e].c||(g={id:h,points:[],xSum:0,ySum:0,cX:null,cY:null},h++,g.points.push(j[e]),b(j,e,-1,g,c,d),b(j,e,1,g,c,d),i.push(g));return i.length>1?!0:!1},a}(QCluster||{}),QCluster=function(a){function b(a,b,c){var d,e,f,g,h;return h=c||0,d=L.CRS.EPSG3857.project(a._southWest).x-c*b,e=L.CRS.EPSG3857.project(a._northEast).x+c*b,f=L.CRS.EPSG3857.project(a._southWest).y-c*b,g=L.CRS.EPSG3857.project(a._northEast).y+c*b,{xmin:d,xmax:e,ymin:f,ymax:g}}function c(a,b){var c,d,b,e;return e=a.getSize().x,c=L.CRS.EPSG3857.project(b._southWest).x,d=L.CRS.EPSG3857.project(b._northEast).x,(d-c)/e}function d(a,b){return a.georef<b.georef?-1:a.georef>b.georef?1:0}function e(a,b,c){function d(a,b){var c,d,e,f,g="";c=Math.pow(10,5-b),60==a&&(a=59.999),a=1e3*a,d=Math.floor(a/c),e=d.toString().length,b>e&&(f=b-e);for(var h=0;f>h;h++)g+="0";return g+=d}var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G=[],H="",F="ABCDEFGHIJKLMNOPQRSTUVWXYZABCDEFGHIJKLMNOPQRSTUVWXYZ";if(n=-90,o=90,p=-180,q=360,r=60,s=4,t=14,u=4,v=5,w=8,x=12,y=14,z=16,A=25,B=78,C=48,PI=3.141592653589793,D=15,E=5e-7,n>b||b>o)return null;if(p>a)return null;if(0>c||c>v)return null;for(a>180&&(a-=360),g=p,h=n,j=(a-g)/D+E,G[0]=j>=0?Math.floor(j):Math.ceil(j),k=a-(G[0]*D+g),G[2]=k>=0?Math.floor(k):Math.ceil(k)+E,e=(k-G[2])*r,l=(b-h)/D+E,G[1]=l>=0?Math.floor(l):Math.ceil(l),m=b-(G[1]*D+h),G[3]=m>=0?Math.floor(m+E):Math.ceil(m+E),f=(m-G[3])*r,i=0;4>i;i++)G[i]>=w&&(G[i]+=1),G[i]>=y&&(G[i]+=1);for(26==G[0]&&(G[0]=A,G[2]=z,e=59.999),13==G[1]&&(G[1]=x,G[3]=z,f=59.999),i=0;4>i;i++)H+=F[G[i]];return H+=d(e,c),H+=d(f,c)}function f(a,b){var c,d;return Math.abs(b)>20037508.3427892?(console.error("Mercator X: "+b+" is > 20037508.3427892."),[null,null]):Math.abs(a)>20037508.3427892?(console.error("Mercator Y: "+a+" is > 20037508.3427892."),[null,null]):(c=b/6378137*57.29577951308232-360*Math.floor((b/6378137*57.29577951308232+180)/360),d=57.29577951308232*(1.5707963267948966-2*Math.atan(Math.exp(-1*a/6378137))),[c,d])}function g(a){var b=[];if(a.features)b=a.features;else if(a instanceof Array)for(var c=a.length-1;c>=0;--c)b=b.concat(a[c].features);else{if(!a[Object.keys(a)[0]].features)return console.err("Faulty Data. No GeoJSON found."),[];for(var f in a)a[f].features&&(b=b.concat(a[f].features))}for(var g=[],h=b.length-1;h>=0;--h){var i=b[h],j=b[h].properties,k=i.geometry.coordinates[0],l=i.geometry.coordinates[1],m=L.CRS.EPSG3857.project(L.latLng(l,k));g.push($.extend(!0,{georef:e(k,l,4),lng:k,lat:l,x:m.x,y:m.y},j))}return g.sort(d)}function h(a){var b,c,f,g,h;for(b=[],f=a.length,c=f-1;c>=0;--c)g=a[c],lng=g.lng,lat=g.lat,h=L.CRS.EPSG3857.project(L.latLng(lat,lng)),b.push($.extend(!0,{georef:e(lng,lat,4),x:h.x,y:h.y},g));return b.sort(d)}return a.PointClusterer=function(b,c,d,e,f){var i=f||{};return this.layerId=c,this.clickHandler=i.clickHandler||this.defaultClickHandler,this.backgroundColor=i.backgroundColor||"#666666",this.dataFormat=i.dataFormat?i.dataFormat.toLowerCase():"pointarray",this.clusterCssClass=e,this.map=d,this.pointIdProperty=i.pointIdProperty||null,this.tolerance=i.clusterTolerance||130,this.mapEdgeBuffer=i.mapEdgeBuffer||a.Utils.HypotenuseOfMapAsInt(d),this.layerVisibility="boolean"==typeof i.layerVisibility?i.layerVisibility:!0,this.reportingProperty=i.reportingProperty||null,i.reportingDictionary?this.addReportingPropertyDictionary(i.reportingDictionary):this.reportingDictionary={},this.defaultPalette=i.defaultPalette||["#8b722c","#e7dfc7","#040707","#c96228","#80adc0","#a19788","#ddecf2","#9e0000","#03671f","#8e2b5c","#e13066","#5c8276","#efa0cb","#62517b","#2c688b","#56c2a7","#e1df2f","#ed3333","#e69890","#545454"],this.mapOrder=i.mapOrder||null,this.reportingValueNA=i.reportingValueNA||{color:"#666666",label:"NA"},this.donutIRFrac=i.donutIRFrac||.4,this.activeCluster=null,this.pointData="geojson"===this.dataFormat?g(b):h(b),this.makeClusters(),this.map.on("moveend",this.mapMove,this),this},a.PointClusterer.prototype.makeClusters=function(){var d,e,g,h,i,j,k,l,m,n,o,p,q,r,s=[],t=[],u=[];if($(this.map._container).is(":visible")){for("undefined"!=typeof this.layer&&this.map.removeLayer(this.layer),n=this.map.getBounds(),o=c(this.map,n),p=b(n,o,this.mapEdgeBuffer),d=a.clusterPoints(this.pointData,p,o,this.tolerance),e={},q=d.length,r=q-1;r>=0;r--){e["cId_"+d[r].id]=d[r],k=d[r].points,g=k.length,h=this.backgroundColor?'<div style="background-color: '+this.backgroundColor+';"><span>'+g+"</span></div>":"<div><span>"+g+"</span></div>",i="leaflet-marker-icon q-marker-cluster "+this.clusterCssClass,1===g?(h='<div><div class="q-marker-single-default"><span>'+g+"</span></div></div></div>",i+=" q-marker-cluster-single",null!==this.reportingProperty&&k[0][this.reportingProperty]&&(m=k[0][this.reportingProperty].toString().split(","),"undefined"!=typeof this.reportingDictionary[m[0]]&&(h='<div style="background-color: '+this.reportingDictionary[m[0]].color+'"><div class="q-marker-single-default"><span>'+g+"</span></div></div></div>"))):i=100>g?i+" q-marker-cluster-small cId_"+d[r].id:1e3>g?i+" q-marker-cluster-medium cId_"+d[r].id:i+" q-marker-cluster-large cId_"+d[r].id,j=L.divIcon({className:i,html:h});var v=f(d[r].cY,d[r].cX);if(l=L.marker([v[1],v[0]],{icon:j}),l.points=k,l.pointIds=[],this.pointIdProperty)for(var w=k.length-1;w>=0;w--)l.pointIds.push(k[w][this.pointIdProperty]);l.stacked=!0,t[0]=Math.round(1e4*k[0].lat)/1e4,u[0]=Math.round(1e4*k[0].lng)/1e4;for(var x=k.length-1;x>=0;x--)if(t[x]=Math.round(1e4*k[x].lat)/1e4,u[x]=Math.round(1e4*k[x].lng)/1e4,t[x]!==t[0]||u[x]!==u[0]){l.stacked=!1;break}if(this.clickHandler&&(this.clickHandler&&l.on("click",this.clickHandler,this),this.idProperty)){l.pointIds=[];for(var w=0,y=g;y>w;w++)l.pointIds.push(k[w][this.idProperty])}s.push(l)}this.clusters=e,this.layer=L.featureGroup(s),this.map.addLayer(this.layer),this.layerVisibility&&(this.map.addLayer(this.layer),"number"==typeof this.mapOrder&&$("."+this.layerId).css("z-index",this.mapOrder),this.reportingProperty&&this.makeDonuts()),this.activeCluster&&this.markActiveCluster()}},a.PointClusterer.prototype.remakeClusters=function(a){this.pointData="geojson"===this.dataFormat?g(a):h(a),this.replaceLayer()},a.PointClusterer.prototype.mapMove=function(){$(this.map._container).is(":visible")&&(this.map.removeLayer(this.layer),this.makeClusters())},a.PointClusterer.prototype.markActiveCluster=function(){if(null!==this.activeCluster)for(var a in this.layer._layers){var b=this.layer._layers[a]._latlng;b.lat===this.activeCluster._latlng.lat&&b.lng===this.activeCluster._latlng.lng&&$(this.layer._layers[a]._icon).toggleClass("active-marker",!0)}},a.PointClusterer.prototype.removeActiveCluster=function(){this.activeCluster=null,$(".leaflet-marker-pane .active-marker").toggleClass("active-marker",!1)},a.PointClusterer.prototype.removeLayer=function(){this.map.off("moveend",this.mapMove,this),this.map.off("click",this.removeActiveCluster,this),this.map.removeLayer(this.layer)},a.PointClusterer.prototype.replaceLayer=function(){this.map.on("moveend",this.mapMove,this),this.map.on("click",function(){this.removeActiveCluster(!0)},this),this.makeClusters()},a.PointClusterer.prototype.defaultClickHandler=function(b){var d,e,f,g,h,i;d=this,d.removeActiveCluster(),e=b.target,g=e.points,i=this.map.getMaxZoom(),f=this.map.getZoom(),h=c(this.map,this.map.getBounds());for(var j=f+1;i>j&&!a.moreThanOneCluster(g,h/this.map.getZoomScale(j),this.tolerance);j++);this.map.setView(e._latlng,j)},a.PointClusterer.prototype.setReportingPropertyColor=function(a,b){var c=this.reportingDictionary[a];c&&(c.color=b)},a.PointClusterer.prototype.setReportingPropertyLabel=function(a,b){var c=this.reportingDictionary[a];c&&(c.label=b)},a.PointClusterer.prototype.addReportingPropertyDictionary=function(a){this.reportingDictionary||(this.reportingDictionary={}),$.extend(this.reportingDictionary,a);var b=Object.keys(this.reportingDictionary);b.forEach(function(a){var b=this.reportingDictionary[a].ClusterColor;b&&(this.reportingDictionary[a].color=b);var c=this.reportingDictionary[a].InfoLabel;c&&(this.reportingDictionary[a].label=c)},this)},a}(QCluster||{}),QCluster=function(a){return a.PointClusterer.prototype.makeDonuts=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=0;o=this.clusters;for(var q in o){b={},a=this.clusters[q].points;for(var r=a.length-1;r>=0;r--){m=a[r][this.reportingProperty].toString().split(",");for(var s=m.length-1,t=s;t>=0;t--)n=m[t],b.hasOwnProperty(n)?b[n].count++:""===n?b.hasOwnProperty("-9999")?b[-9999].count++:b[-9999]={count:1,color:this.reportingValueNA.color,alias:this.reportingValueNA.label}:("undefined"==typeof this.reportingDictionary[n]&&(p===this.defaultPalette.length&&(p=0),this.reportingDictionary[n]={color:this.defaultPalette[p],label:n},p+=1),b[n]={count:1,color:this.reportingDictionary[n].color,label:this.reportingDictionary[n].label})}c=[],d=[];for(var r in b)c.push(b[r]);for(var u={count:0,color:this.reportingValueNA.color,label:this.reportingValueNA.label},t=0,s=c.length;s>t;t++)c[t].label===this.reportingValueNA.label?u.count=u.count+c[t].count:d.push(c[t]);d.push(u),h=$("."+this.clusterCssClass+"."+q),e=$(h).width(),f=$(h).height(),g=Math.min(e,f)/2,i=d3.layout.pie().sort(null),j=d3.svg.arc().innerRadius(g-g*this.donutIRFrac).outerRadius(g),k=d3.select("."+this.clusterCssClass+"."+q).append("svg").attr("class","clusterDonut").attr("width",e).attr("height",f).append("g").attr("transform","translate("+e/2+","+f/2+")"),l=k.selectAll("path").data(function(){var a,b,c;a=d,b=[];for(var e=0,f=a.length;f>e;e++)b.push(a[e].count);c=i(b);for(var e=0,f=c.length;f>e;e++)c[e].data=a[e];return c}).enter().append("path").attr("fill",function(a){return a.data.color}).attr("d",j)}},a}(QCluster||{}),QCluster=function(a){return a.Utils=function(a){return a.FacetColorLibrary=function(a,b,c,d,e){var f,g,h,i,j,k;return f=e||{},h=f.colorPalette||["#8b722c","#e7dfc7","#040707","#c96228","#80adc0","#a19788","#ddecf2","#9e0000","#03671f","#8e2b5c","#e13066","#5c8276","#efa0cb","#62517b","#2c688b","#56c2a7","#e1df2f","#ed3333","#e69890","#545454"],i=f.maxColors||50,j=f.otherColor||"#666666",k={id:a,name:b,values_keyVal:{},values_arr:[],otherColor:j},_.each(c,function(a,b){var c={id:a[d.id],name:a[d.name],color:a[d.color]};("undefined"==typeof c.color||null===c.color)&&(b>i-1?c.color=j:b>h.length-1?(g=b%h.length-1,c.color=h[g]):c.color=h[b]),k.values_keyVal[c.id]=c,k.values_arr.push(c)}),k},a.HypotenuseOfMapAsInt=function(a){var b=$(a.getContainer()),c=b.width(),d=b.height();return Math.floor(Math.sqrt(c*c+d*d))},a}(a.Utils||{}),a}(QCluster||{});
//# sourceMappingURL=q-cluster.map.js